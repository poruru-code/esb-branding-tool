# Auto-generated by branding generator. Do not edit directly.
# Source: tools/branding/templates/docker-compose.fc.yml.tmpl
services:
  # ------------------------------------------
  # 1. Runtime Node (Parent Container)
  # ------------------------------------------
  runtime-node:
    build:
      context: services/runtime-node
      dockerfile: Dockerfile.firecracker
    container_name: {{ENV_PREFIX_VAR}}_PROJECT_NAME:-{{SLUG}}}-runtime-node
    entrypoint: /entrypoint.firecracker.sh
    privileged: true
    ports:
      - "{{ENV_PREFIX_VAR}}_PORT_AGENT_GRPC:-0}:50051"
    networks:
      - external_network
    volumes:
      - {{ENV_PREFIX_VAR}}_CERT_DIR:-~/{{HOME_DIR}}/certs}:/app/config/ssl:ro
    environment:
      - CNI_GW_IP=10.88.0.1
      - DNAT_APPLY_OUTPUT=1
      # Local Integration
      - DNAT_S3_IP=127.0.0.1
      - DNAT_DB_IP=127.0.0.1
      - DNAT_VL_IP=127.0.0.1
    healthcheck:
      test: ["CMD", "ctr", "-a", "/run/containerd/containerd.sock", "version"]
      interval: 5s
      retries: 10
    restart: unless-stopped

  # ------------------------------------------
  # 1.5. coredns (Local DNS for Lambda VMs)
  # ------------------------------------------
  coredns:
    image: coredns/coredns:1.11.1
    container_name: {{ENV_PREFIX_VAR}}_PROJECT_NAME:-{{SLUG}}}-coredns
    network_mode: "service:runtime-node"
    volumes:
      - ./config/Corefile:/Corefile:ro
    extra_hosts:
      - "gateway:{{ENV_PREFIX_VAR}}_CONTROL_HOST:-10.99.0.1}"
      - "s3-storage:{{ENV_PREFIX_VAR}}_CONTROL_HOST:-10.99.0.1}"
      - "database:{{ENV_PREFIX_VAR}}_CONTROL_HOST:-10.99.0.1}"
      - "victorialogs:{{ENV_PREFIX_VAR}}_CONTROL_HOST:-10.99.0.1}"
      - "registry:{{ENV_PREFIX_VAR}}_CONTROL_HOST:-10.99.0.1}"
    command: -conf /Corefile
    depends_on:
      runtime-node: { condition: service_started }
    restart: unless-stopped


  # ------------------------------------------
  # 2. Agent Wiring (Child Container)
  # ------------------------------------------
  agent:
    network_mode: "service:runtime-node"
    pid: "container:{{ENV_PREFIX_VAR}}_PROJECT_NAME:-{{SLUG}}}-runtime-node"
    depends_on:
      runtime-node: { condition: service_healthy }
    volumes:
      - runtime_containerd_run:/run/containerd
      - runtime_containerd_lib:/var/lib/containerd
      - {{SLUG}}_cni_data:/var/lib/cni
      - ./services/agent/config/cni:/etc/cni/net.d:ro
    environment:
      - AGENT_RUNTIME=containerd
      - CONTAINERD_RUNTIME=aws.firecracker
      - CONTAINER_REGISTRY=registry:5010

  # ------------------------------------------
  # 3. Gateway Wiring (WireGuard for FC Mode)
  # ------------------------------------------
  gateway:
    user: "0:0"
    build:
      context: .
      dockerfile: services/gateway/Dockerfile.firecracker
      additional_contexts:
        config: {{ENV_PREFIX_VAR}}_CONFIG_DIR:-services/gateway/config}
      args:
        {{ENV_PREFIX}}_UID: {{ENV_PREFIX_VAR}}_UID:-1000}
        {{ENV_PREFIX}}_GID: {{ENV_PREFIX_VAR}}_GID:-1000}
    ports:
      - "{{ENV_PREFIX_VAR}}_PORT_GATEWAY_HTTPS:-0}:8443"
    networks:
      - external_network
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - {{ENV_PREFIX_VAR}}_WG_GATEWAY_CONF:-~/{{HOME_DIR}}/wireguard/gateway/wg0.conf}:/app/config/wireguard/wg0.conf:ro
      - ./config/haproxy.gateway.cfg:/app/config/haproxy.gateway.cfg:ro
    depends_on:
      agent: { condition: service_started }
    environment:
      # Connect to Runtime Node (Host of Agent)
      - AGENT_GRPC_ADDRESS=runtime-node:50051
      # WireGuard endpoint for Lambda -> Gateway
      - GATEWAY_INTERNAL_URL=https://10.99.0.1:8443
      - {{ENV_PREFIX}}_IMAGE_TAG={{ENV_PREFIX_VAR}}_IMAGE_TAG:-}
      - FUNCTION_IMAGE_PREFIX=registry:5010/
      - GATEWAY_WORKER_ROUTE_VIA_HOST=${GATEWAY_WORKER_ROUTE_VIA_HOST:-}
      - GATEWAY_WORKER_ROUTE_VIA=${GATEWAY_WORKER_ROUTE_VIA:-}
      - GATEWAY_WORKER_ROUTE_CIDR=${GATEWAY_WORKER_ROUTE_CIDR:-10.88.0.0/16}

volumes:
  runtime_containerd_run:
  runtime_containerd_lib:
  {{SLUG}}_cni_data:
