# Auto-generated by branding generator. Do not edit directly.
# Source: tools/branding/templates/docker-compose.fc-node.yml.tmpl

services:
  # ============================================
  # Base Images (Debian 12)
  # ============================================
  os-base:
    image: {{SLUG}}-os-base:latest
    build:
      context: services/common
      dockerfile: Dockerfile.os-base
      args:
        ROOT_CA_MOUNT_ID: root_ca
        ROOT_CA_CERT_FILENAME: ${ROOT_CA_CERT_FILENAME:-rootCA.crt}
        ROOT_CA_FINGERPRINT: ${ROOT_CA_FINGERPRINT:-}

      secrets:
        - root_ca

  python-base:
    image: {{SLUG}}-python-base:latest
    build:
      context: services/common
      dockerfile: Dockerfile.python-base
      args:
        ROOT_CA_MOUNT_ID: root_ca
        ROOT_CA_CERT_FILENAME: ${ROOT_CA_CERT_FILENAME:-rootCA.crt}
        ROOT_CA_FINGERPRINT: ${ROOT_CA_FINGERPRINT:-}
      secrets:
        - root_ca

  # ============================================
  # Permission Helper (for RustFS)
  # ============================================
  permission-helper:
    image: alpine
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-permission-helper
    volumes:
      - rustfs_data:/data/rustfs
    command: >
      sh -c "
        chown -R 10001:10001 /data/rustfs 2>/dev/null || true && echo 'RustFS permissions fixed'
      "
    restart: "no"

  # ============================================
  # RustFS (S3 Compatible Storage)
  # ============================================
  s3-storage:
    image: rustfs/rustfs:latest
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-s3-storage
    depends_on:
      permission-helper:
        condition: service_completed_successfully
    ports:
      - "${PORT_S3:-9000}:9000" # S3 API
      - "${PORT_S3_MGMT:-9001}:9001" # Console
    volumes:
      - rustfs_data:/data/rustfs
    environment:
      - RUSTFS_VOLUMES=/data/rustfs
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY:-}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY:-}
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
      - RUSTFS_DEDUPLICATION=${RUSTFS_DEDUPLICATION:-true}
      - RUSTFS_COMPRESSION=${RUSTFS_COMPRESSION:-auto}
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -f --noproxy '*' http://127.0.0.1:9000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      external_network: {}

  # ============================================
  # ScyllaDB (DynamoDB Compatible DB)
  # ============================================
  database:
    image: scylladb/scylla:latest
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-database
    ports:
      - "${PORT_DATABASE:-8000}:8000" # Alternator API (Host dynamic -> Container 8000)
    volumes:
      - scylladb_data:/var/lib/scylla
    command: --smp 1 --memory ${SCYLLADB_MEMORY:-1}G --developer-mode 1 --alternator-port 8000 --alternator-address 0.0.0.0 --alternator-write-isolation always_use_lwt
    healthcheck:
      test: [ "CMD-SHELL", "cqlsh -e 'DESCRIBE KEYSPACES' || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 180s
    restart: unless-stopped
    networks:
      external_network: {}

  # ============================================
  # VictoriaLogs
  # ============================================
  victorialogs:
    image: victoriametrics/victoria-logs:latest
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-victorialogs
    ports:
      - "${PORT_VICTORIALOGS:-9428}:9428" # VictoriaLogs UI/API
    volumes:
      - victorialogs_data:/victoria-logs-data
    command:
      - "-storageDataPath=/victoria-logs-data"
      - "-retentionPeriod=7d"
    healthcheck:
      test: [ "CMD", "wget", "-q", "-Y", "off", "--spider", "http://127.0.0.1:9428/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      external_network: {}

  # ============================================
  # Provisioner (Runtime Resource Initialization)
  # ============================================
  provisioner:
    image: ${ESB_REGISTRY:-registry:5010/}{{SLUG}}-provisioner:${ESB_TAG:-latest}
    build:
      context: services/provisioner
      dockerfile: Dockerfile
      additional_contexts:
        config: ${CONFIG_DIR:-services/gateway/config}
        generator_assets: ${GENERATOR_ASSETS_CONTEXT:-cli/internal/generator/assets/site-packages}
      args:
        PYTHON_BASE_IMAGE: {{SLUG}}-python-base:latest

    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-provisioner
    depends_on:
      database:
        condition: service_healthy
      s3-storage:
        condition: service_healthy
      victorialogs:
        condition: service_healthy
    environment:
      - DYNAMODB_ENDPOINT=http://database:8000
      - S3_ENDPOINT=http://s3-storage:9000
      - VICTORIALOGS_URL=http://victorialogs:9428
      - PYTHONUNBUFFERED=1
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=${RUSTFS_ACCESS_KEY:-{{SLUG}}}
      - AWS_SECRET_ACCESS_KEY=${RUSTFS_SECRET_KEY:-{{SLUG}}secret}
      - AGENT_RUNTIME=containerd
    networks:
      external_network: {}

  # ============================================
  # Runtime Node (Containerd Host Container)
  # ============================================
  runtime-node:
    image: ${ESB_REGISTRY:-registry:5010/}{{SLUG}}-runtime-node-containerd:${ESB_TAG:-latest}
    build:
      context: services/runtime-node
      dockerfile: Dockerfile.containerd
      args:
        OS_BASE_IMAGE: {{SLUG}}-os-base:latest

    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-runtime-node
    entrypoint: /entrypoint.firecracker.sh
    privileged: true
    ports:
      - "${PORT_AGENT_GRPC:-50051}:50051"
      - "${PORT_GATEWAY_HTTPS:-443}:8443" # Gateway port (shared network)
      - "${PORT_AGENT_METRICS:-9091}:9091" # Agent Metrics
    networks:
      - external_network
    environment:
      - CNI_GW_IP=${DATA_PLANE_HOST:-10.88.0.1}
      - VHOST_VSOCK_REQUIRED=0
      - AGENT_RUNTIME=containerd
      - CONTAINERD_RUNTIME=aws.firecracker
    volumes:
      - runtime_containerd_run:/run/containerd
      - runtime_containerd_lib:/var/lib/containerd
      - ${CERT_DIR:-~/{{HOME_DIR}}/certs}:/app/config/ssl:ro
    healthcheck:
      test: ["CMD", "ctr", "-a", "/run/containerd/containerd.sock", "version"]
      interval: 5s
      retries: 10
    restart: unless-stopped

  # ============================================
  # coredns (Local DNS for Lambda VMs)
  # ============================================
  coredns:
    image: coredns/coredns:1.11.1
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-coredns
    network_mode: "service:runtime-node"
    volumes:
      - ./config/Corefile:/Corefile:ro
    command: -conf /Corefile
    depends_on:
      runtime-node: { condition: service_started }
    restart: unless-stopped

  # ============================================
  # Agent (Containerd Runtime)
  # ============================================
  agent:
    image: ${ESB_REGISTRY:-registry:5010/}{{SLUG}}-agent-containerd:${ESB_TAG:-latest}
    build:
      context: services/agent
      dockerfile: Dockerfile.containerd
      additional_contexts:
        meta_module: ${META_MODULE_CONTEXT:-meta}
      args:
        OS_BASE_IMAGE: {{SLUG}}-os-base:latest

    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-agent
    cap_add: [NET_ADMIN, SYS_ADMIN]
    network_mode: "service:runtime-node"
    pid: "service:runtime-node"
    depends_on:
      runtime-node: { condition: service_healthy }
      registry: { condition: service_healthy }
    volumes:
      - runtime_containerd_run:/run/containerd
      - runtime_containerd_lib:/var/lib/containerd
      - esb_cni_data:/var/lib/cni
      - esb_cni_conf:/etc/cni/net.d
      - ${CERT_DIR:-~/{{HOME_DIR}}/certs}:/app/config/ssl:ro
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ESB_TAG=${ESB_TAG:-latest}
      - PORT=50051
      - CONTAINER_REGISTRY=${CONTAINER_REGISTRY:-registry:5010}
      - CONTAINER_REGISTRY_INSECURE=${CONTAINER_REGISTRY_INSECURE:-1}
      - CNI_SUBNET=${CNI_SUBNET:-}
      - AGENT_RUNTIME=containerd
      - CONTAINERD_RUNTIME=aws.firecracker
      - AGENT_GRPC_TLS_ENABLED=1
      - AGENT_GRPC_CERT_PATH=/app/config/ssl/server.crt
      - AGENT_GRPC_KEY_PATH=/app/config/ssl/server.key
      - AGENT_GRPC_CA_CERT_PATH=/app/config/ssl/rootCA.crt
      - CONTAINERS_NETWORK=${NETWORK_EXTERNAL:-${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-external}
      - ENV
    command: ["/app/agent"]
    restart: unless-stopped

  # ============================================
  # Registry (Local OCI)
  # ============================================
  registry:
    image: registry:2
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-registry
    ports:
      - "${PORT_REGISTRY:-5010}:5010"
    volumes:
      - registry_data:/var/lib/registry
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5010
    healthcheck:
      test: ["CMD", "wget", "-q", "-Y", "off", "--spider", "http://127.0.0.1:5010/v2/"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - external_network

  # ============================================
  # API Gateway (Facade)
  # ============================================
  gateway:
    image: ${ESB_REGISTRY:-registry:5010/}{{SLUG}}-gateway-containerd:${ESB_TAG:-latest}
    user: "0:0"
    build:
      context: services/gateway
      dockerfile: Dockerfile.containerd
      additional_contexts:
        config: ${CONFIG_DIR:-services/gateway/config}
        common: ${COMMON_CONTEXT:-services/common}
      args:
        PYTHON_BASE_IMAGE: {{SLUG}}-python-base:latest
        SERVICE_USER: {{SLUG}}
        SERVICE_UID: ${RUN_UID:-1000}
        SERVICE_GID: ${RUN_GID:-1000}

    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-gateway
    network_mode: "service:runtime-node"
    depends_on:
      agent: { condition: service_started }
      provisioner: { condition: service_completed_successfully }
      database:
        condition: service_healthy
      s3-storage:
        condition: service_healthy
    volumes:
      - ${WG_GATEWAY_CONF:-~/{{HOME_DIR}}/wireguard/gateway/wg0.conf}:/app/config/wireguard/wg0.conf:ro
      - ./config/haproxy.gateway.cfg:/app/config/haproxy.gateway.cfg:ro
      - ${CERT_DIR:-~/{{HOME_DIR}}/certs}:/app/config/ssl:ro
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      # --- Required / Core Authentication (auto-generated if unset) ---
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-}
      - X_API_KEY=${X_API_KEY:-}
      - AUTH_USER=${AUTH_USER:-}
      - AUTH_PASS=${AUTH_PASS:-}
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY:-}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY:-}

      # --- Server & Network Configuration ---
      - UVICORN_BIND_ADDR=0.0.0.0:8443
      - ENABLE_SSL=true
      - SSL_CERT_PATH=/app/config/ssl/server.crt
      - SSL_KEY_PATH=/app/config/ssl/server.key
      - CONTAINERS_NETWORK=${NETWORK_EXTERNAL:-${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-external}
      - AUTH_ENDPOINT_PATH
      - PROJECT_NAME=${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}

      # --- Tuning & Resilience (Pass-through) ---
      - AGENT_INVOKE_PROXY
      - LAMBDA_INVOKE_TIMEOUT
      - CIRCUIT_BREAKER_THRESHOLD
      - CIRCUIT_BREAKER_RECOVERY_TIMEOUT

      # --- Observability ---
      - LOG_LEVEL
      - LOG_PAYLOADS
      - PYTHONUNBUFFERED=1
      - VICTORIALOGS_URL=${VICTORIALOGS_URL:-http://victorialogs:9428}  # Gateway -> VictoriaLogs

      # --- Auto-Scaling ---
      - DEFAULT_MAX_CAPACITY=${DEFAULT_MAX_CAPACITY:-1}
      - DEFAULT_MIN_CAPACITY=${DEFAULT_MIN_CAPACITY:-0}
      - POOL_ACQUIRE_TIMEOUT=${POOL_ACQUIRE_TIMEOUT:-5.0}
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-30}
      - GATEWAY_IDLE_TIMEOUT_SECONDS=${GATEWAY_IDLE_TIMEOUT_SECONDS:-300}
      - ENABLE_CONTAINER_PAUSE=${ENABLE_CONTAINER_PAUSE:-false}
      - PAUSE_IDLE_SECONDS=${PAUSE_IDLE_SECONDS:-30}

      # --- System / Proxy ---
      - GRPC_VERBOSITY=ERROR

      # --- Containerd Mode Wiring ---
      - AGENT_RUNTIME=containerd
      - AGENT_GRPC_ADDRESS=localhost:50051
      - AGENT_GRPC_TLS_ENABLED=1
      - AGENT_GRPC_TLS_CA_CERT_PATH=/app/config/ssl/rootCA.crt
      - AGENT_GRPC_TLS_CERT_PATH=/app/config/ssl/client.crt
      - AGENT_GRPC_TLS_KEY_PATH=/app/config/ssl/client.key
      - GATEWAY_INTERNAL_URL=https://${DATA_PLANE_HOST:-10.88.0.1}:8443
      - DATA_PLANE_HOST=${DATA_PLANE_HOST:-10.88.0.1}
      - DYNAMODB_ENDPOINT=http://database:8000
      - S3_ENDPOINT=http://s3-storage:9000
      - GATEWAY_VICTORIALOGS_URL=http://victorialogs:9428
volumes:
  scylladb_data:
  rustfs_data:
  victorialogs_data:
  registry_data:
  runtime_containerd_run:
  runtime_containerd_lib:
  esb_cni_data:
  esb_cni_conf:

secrets:
  root_ca:
    file: ${CERT_DIR:-~/{{HOME_DIR}}/certs}/rootCA.crt

networks:
  external_network:
    name: ${NETWORK_EXTERNAL:-${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-external}
    driver: bridge
