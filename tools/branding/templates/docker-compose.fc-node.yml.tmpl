# Auto-generated by branding generator. Do not edit directly.
# Source: tools/branding/templates/docker-compose.fc-node.yml.tmpl

services:
  # ============================================
  # Runtime Node (Parent Container)
  # ============================================
  runtime-node:
    build:
      context: services/runtime-node
      dockerfile: Dockerfile.firecracker
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-runtime-node
    entrypoint: /entrypoint.firecracker.sh
    privileged: true
    ports:
      - "${PORT_AGENT_GRPC:-50051}:50051"
    networks:
      - external_network
    volumes:
      - ${CERT_DIR:-~/{{HOME_DIR}}/certs}:/app/config/ssl:ro
    environment:
      - CNI_GW_IP=10.88.0.1
      - DNAT_APPLY_OUTPUT=1
      - DNAT_S3_IP=127.0.0.1
      - DNAT_DB_IP=127.0.0.1
      - DNAT_VL_IP=127.0.0.1
    healthcheck:
      test: ["CMD", "ctr", "-a", "/run/containerd/containerd.sock", "version"]
      interval: 5s
      retries: 10
    restart: unless-stopped

  # ============================================
  # coredns (Local DNS for Lambda VMs)
  # ============================================
  coredns:
    image: coredns/coredns:1.11.1
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-coredns
    network_mode: "service:runtime-node"
    volumes:
      - ./config/Corefile:/Corefile:ro
    extra_hosts:
      - "gateway:${CONTROL_HOST:-10.99.0.1}"
      - "s3-storage:${CONTROL_HOST:-10.99.0.1}"
      - "database:${CONTROL_HOST:-10.99.0.1}"
      - "victorialogs:${CONTROL_HOST:-10.99.0.1}"
      - "registry:${CONTROL_HOST:-10.99.0.1}"
    command: -conf /Corefile
    depends_on:
      runtime-node: { condition: service_started }
    restart: unless-stopped

  # ============================================
  # Agent (Firecracker Runtime)
  # ============================================
  agent:
    env_file: config/defaults.env
    image: {{SLUG}}-agent:firecracker
    build:
      context: services/agent
      dockerfile: Dockerfile
      additional_contexts:
        meta: meta
      args:
        OS_BASE_IMAGE: {{SLUG}}-os-base:latest
    container_name: ${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-agent
    cap_add: [NET_ADMIN, SYS_ADMIN]
    network_mode: "service:runtime-node"
    pid: "service:runtime-node"
    depends_on:
      runtime-node: { condition: service_healthy }
    volumes:
      - runtime_containerd_run:/run/containerd
      - runtime_containerd_lib:/var/lib/containerd
      - esb_cni_data:/var/lib/cni
      - esb_cni_conf:/etc/cni/net.d
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PORT=50051
      - CONTAINER_REGISTRY=registry:5010
      - CNI_SUBNET=${CNI_SUBNET:-}
      - AGENT_RUNTIME=containerd
      - CONTAINERD_RUNTIME=aws.firecracker
      # mTLS (disabled for Firecracker mode)
      # - AGENT_GRPC_TLS_ENABLED=1
      # - AGENT_GRPC_CERT_PATH=/app/config/ssl/server.crt
      # - AGENT_GRPC_KEY_PATH=/app/config/ssl/server.key
      # - AGENT_GRPC_CA_CERT_PATH=/app/config/ssl/rootCA.crt
    command: ["/app/agent"]
    restart: unless-stopped

volumes:
  runtime_containerd_run:
  runtime_containerd_lib:
  esb_cni_data:
  esb_cni_conf:

networks:
  external_network:
    name: ${NETWORK_EXTERNAL:-${PROJECT_NAME:-{{SLUG}}-${ENV:-default}}-external}
    external: true
