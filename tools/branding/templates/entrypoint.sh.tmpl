#!/bin/bash
# Auto-generated by branding generator. Do not edit directly.
# Source: tools/branding/templates/entrypoint.sh.tmpl
# Where: entrypoint.sh
# What: Main entrypoint for the runtime-node CLI wrapper.
# Why: Keep startup logic independent of the underlying brand.
set -e

echo "Starting Docker daemon..."
# Start the Docker daemon in the background.
dockerd-entrypoint.sh &

# Wait for the Docker daemon to start.
timeout=${DOCKER_DAEMON_TIMEOUT:-60}
while ! docker info > /dev/null 2>&1; do
    if [ $timeout -le 0 ]; then
        echo "ERROR: Docker daemon failed to start"
        exit 1
    fi
    echo "Waiting for Docker daemon to start... ($timeout seconds remaining)"
    sleep 1
    timeout=$((timeout - 1))
done

echo "Docker daemon started successfully"


# Load prebuilt images (.tar) if present (to speed up startup).
if [ -d /app/build/lambda-images ]; then
    echo "Checking for pre-built images..."
    for tarfile in /app/build/lambda-images/*.tar; do
        if [ -f "$tarfile" ]; then
            echo "Loading pre-built image: $tarfile..."
            docker load -i "$tarfile"
        fi
    done
fi

# Start the environment using the branded CLI.
# --build: generate configuration and build missing images.
# --detach: start services in the background.
echo "Starting via CLI..."
cd /app
{{CLI_NAME}} up --build --detach

# Tail logs to keep the container alive.
echo "All services started. Tailing logs..."
docker compose logs -f
