# Auto-generated by branding generator. Do not edit directly.
# Source: tools/branding/templates/Makefile.tmpl
# Where: tools/branding/templates/Makefile.tmpl
# What: Container image validation helpers (CST + Dockle) template.
# Why: Keep generated Makefile in sync with runtime image naming rules.

SHELL := /bin/bash

CST_IMAGE ?= gcr.io/gcp-runtimes/container-structure-test:v1.16.0
DOCKLE_IMAGE ?= goodwithtech/dockle:v0.4.14
DOCKLE_TMP_DIR ?= /tmp
DOCKLE_TMP_MODE ?= file
BRAND_SLUG ?= {{SLUG}}
IMAGE_TAG ?= latest
DOCKLE_TMP_VOLUME ?= $(BRAND_SLUG)-dockle-tmp
DOCKLE_IGNORES ?= $(shell if [ -f .dockleignore ]; then grep -vE '^[[:space:]]*(#|$$)' .dockleignore | paste -sd, -; fi)

CST_CONFIG_DIR := config/container-structure-test

OS_BASE_IMAGE ?= $(BRAND_SLUG)-os-base:latest
PYTHON_BASE_IMAGE ?= $(BRAND_SLUG)-python-base:latest
GATEWAY_IMAGE ?= $(BRAND_SLUG)-gateway:$(IMAGE_TAG)-docker
GATEWAY_FC_IMAGE ?= $(BRAND_SLUG)-gateway:$(IMAGE_TAG)-containerd
AGENT_IMAGE ?= $(BRAND_SLUG)-agent:$(IMAGE_TAG)-docker
AGENT_CONTAINERD_IMAGE ?= $(BRAND_SLUG)-agent:$(IMAGE_TAG)-containerd
RUNTIME_NODE_IMAGE ?= $(BRAND_SLUG)-runtime-node:$(IMAGE_TAG)-containerd
RUNTIME_NODE_FC_IMAGE ?= $(BRAND_SLUG)-runtime-node:$(IMAGE_TAG)-containerd

CST_RUN := docker run --rm \
	-v /var/run/docker.sock:/var/run/docker.sock \
	-v $(PWD):/work -w /work \
	$(CST_IMAGE)

DOCKLE_EXIT_CODE ?= 1
DOCKLE_EXIT_LEVEL ?= warn
ifneq ($(strip $(DOCKLE_IGNORES)),)
DOCKLE_ENV := -e DOCKLE_IGNORES=$(DOCKLE_IGNORES)
endif

DOCKLE_RUN := docker run --rm \
	$(DOCKLE_ENV) \
	-v $(DOCKLE_TMP_DIR):$(DOCKLE_TMP_DIR) \
	$(DOCKLE_IMAGE)

DOCKLE_RUN_VOLUME := docker run --rm \
	$(DOCKLE_ENV) \
	-v $(DOCKLE_TMP_VOLUME):/dockle \
	$(DOCKLE_IMAGE)

ifneq ($(strip $(ACT)),)
DOCKLE_TMP_MODE := volume
endif

define run_dockle_input
	@if [ "$(DOCKLE_TMP_MODE)" = "volume" ]; then \
		docker volume create $(DOCKLE_TMP_VOLUME) >/dev/null; \
		docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $(DOCKLE_TMP_VOLUME):/dockle docker:26-cli \
			docker save $(1) -o /dockle/image.tar; \
		$(DOCKLE_RUN_VOLUME) --exit-code $(DOCKLE_EXIT_CODE) --exit-level $(DOCKLE_EXIT_LEVEL) --input /dockle/image.tar; \
		docker volume rm $(DOCKLE_TMP_VOLUME) >/dev/null 2>&1 || true; \
	else \
		tmp=$$(mktemp $(DOCKLE_TMP_DIR)/dockle-XXXXXX.tar); \
		trap 'rm -f $$tmp' EXIT; \
		docker save $(1) -o $$tmp; \
		$(DOCKLE_RUN) --exit-code $(DOCKLE_EXIT_CODE) --exit-level $(DOCKLE_EXIT_LEVEL) --input $$tmp; \
	fi
endef

.PHONY: \
	cst cst-all \
	cst-os-base cst-python-base cst-gateway cst-gateway-firecracker cst-agent cst-agent-containerd \
	cst-runtime-node cst-runtime-node-firecracker \
	dockle dockle-all \
	dockle-os-base dockle-python-base dockle-gateway dockle-gateway-firecracker \
	dockle-agent dockle-runtime-node dockle-runtime-node-firecracker

cst: cst-os-base cst-python-base cst-gateway cst-agent

cst-all: cst cst-agent-containerd cst-runtime-node cst-runtime-node-firecracker cst-gateway-firecracker

cst-os-base:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/os-base.yaml --image $(OS_BASE_IMAGE)

cst-python-base:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/python-base.yaml --image $(PYTHON_BASE_IMAGE)

cst-gateway:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/gateway.yaml --image $(GATEWAY_IMAGE)

cst-gateway-firecracker:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/gateway-firecracker.yaml --image $(GATEWAY_FC_IMAGE)

cst-agent:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/agent.yaml --image $(AGENT_IMAGE)

cst-agent-containerd:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/agent-containerd.yaml --image $(AGENT_CONTAINERD_IMAGE)

cst-runtime-node:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/runtime-node.yaml --image $(RUNTIME_NODE_IMAGE)

cst-runtime-node-firecracker:
	$(CST_RUN) test --config $(CST_CONFIG_DIR)/runtime-node-firecracker.yaml --image $(RUNTIME_NODE_FC_IMAGE)

dockle: dockle-os-base dockle-python-base dockle-gateway dockle-agent

dockle-all: dockle dockle-runtime-node dockle-runtime-node-firecracker dockle-gateway-firecracker

dockle-os-base:
	$(call run_dockle_input,$(OS_BASE_IMAGE))

dockle-python-base:
	$(call run_dockle_input,$(PYTHON_BASE_IMAGE))

dockle-gateway:
	$(call run_dockle_input,$(GATEWAY_IMAGE))

dockle-gateway-firecracker:
	$(call run_dockle_input,$(GATEWAY_FC_IMAGE))

dockle-agent:
	$(call run_dockle_input,$(AGENT_IMAGE))

dockle-runtime-node:
	$(call run_dockle_input,$(RUNTIME_NODE_IMAGE))

dockle-runtime-node-firecracker:
	$(call run_dockle_input,$(RUNTIME_NODE_FC_IMAGE))
